      program binlen_images
      implicit none

      real*8 width, radius12, radius22
      real*8 mrhomin,mgridsize,s_r_max
      real*8 b, q, alpha
      integer ncount, DIM1,DIM2
      real*8 sgxmax,sgymax
      parameter (DIM1=40000000)
      parameter (DIM2= 3000000)
      integer sind_s(DIM2),sind_e(DIM2)
      real*4 centroidx(DIM2),centroidy(DIM2)
      real*4 centerx(DIM2),centery(DIM2) 
      character*1 hbd(DIM2)
      real*4 msx(DIM1),msy(DIM1)
      character*1 cbd(DIM1)
      integer*4 boxind(DIM1)
      real*8 sgxmin,sgymin,sgrid
      real*8 rho2,magpar
      integer sgxnum,sgynum,s_ind_s,s_ind_e
      real*8 h, h_x, h_y
      real*8 scx, scy
      logical readerr

      real*8 offset_x, offset_y

      integer nparmout
      parameter (nparmout = 7)
      real*8 aoutp(nparmout)
c     sol1
c      data aoutp/9601.1868114d0,0.0331539d0,60.4355925d0,
c     +0.434467454d0,0.263026799d0,2.4776190d0,0.057262687d0/

c     sol2
c      data aoutp/9601.3806682d0,0.0494265d0,47.8594503d0,
c     +0.409156864d0,0.575439937d0,4.0242857d0,0.083773433d0/

      real*8 PI
      parameter (PI = 3.1415926535d0)

      real*8 theta
      real*8 t0, u0, te, rhos, t, tau, xs, ys

      integer nt, it
      parameter (nt = 4)
      real*8 mt(nt)
      data mt/9601.86,9602.86,9604.86,9605.86/

      character*7 numstr

      open(1,file = 'parameters.txt',status='old')
      read(1,*) aoutp
      close(1)

ccccccccccccccccccccccccccccccccccccccccccccc
      width = 0.4d0

      radius12=(1d0+width)**2
      radius22=(1d0-width)**2

      mrhomin   = 0.1d0
      mgridsize = 0.02*0.1d0
      s_r_max   = 0.405d0
ccccccccccccccccccccccccccccccccccccccccccccc

      t0    = aoutp(1)
      u0    = aoutp(2)
      te    = aoutp(3)
      b     = aoutp(4)
      q     = aoutp(5)
      theta = aoutp(6)
      rhos  = aoutp(7)

      rho2 = rhos*rhos

      do it=1,nt

      t = mt(it)
      tau=(t-t0)/te

      if(b.lt.1)then
      offset_x=b*(-0.5d0+1d0/(1d0+q))
      else
      offset_x=b/2d0 -q/(1d0+q)/b
      endif
      offset_y = 0.d0

      tau=(t-t0)/te

      xs= tau*cos(theta)+u0*sin(theta)  -offset_x
      ys=-tau*sin(theta)+u0*cos(theta)  -offset_y

      write(numstr, 606) t
606   format(f7.2)

      open(98,file= 'img.'//numstr//'.txt', status='unknown')

      call imagemap_binary(b,q,
     +           mrhomin,width
     +           ,DIM1
     +           ,msx,msy,cbd,boxind
     +           ,ncount
     +           ,mgridsize
     +           ,scx,scy
     +           ,sgxmin,sgymin,sgxnum,sgynum
     +           ,h,h_x,h_y
     +           ,s_ind_s,s_ind_e
     +           ,readerr
     +           ,s_r_max,
     +           xs,ys,rho2)   

      close(98)
      enddo

      if(readerr) then
      write(6,*) 'Map Generation Error'
      write(6,*) 'Program is halted'
      endif

      end
